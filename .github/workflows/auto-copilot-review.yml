name: Auto GitHub Copilot Review

on:
  pull_request:
    types: [opened, reopened]

jobs:
  setup-copilot-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Setup GitHub Copilot Review Instructions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pullNumber = context.payload.pull_request.number;
            const currentBody = context.payload.pull_request.body || '';
            
            // GitHub Copilotã¸ã®æŒ‡ç¤ºã‚’å«ã‚€æ–°ã—ã„PRèª¬æ˜æ–‡
            const copilotInstructions = `<!-- GitHub Copilot Review Instructions -->
@github-copilot ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ—¥æœ¬èªã§ã€ä»¥ä¸‹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
[must] å¿…é ˆå¤‰æ›´, [imo] æ„è¦‹, [nits] äº›ç´°ãªæŒ‡æ‘˜, [ask] è³ªå•, [fyi] å‚è€ƒæƒ…å ±

---

`;
            
            // æ—¢å­˜ã®èª¬æ˜æ–‡ã«Copilotã®æŒ‡ç¤ºã‚’è¿½åŠ ï¼ˆæ—¢ã«å­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
            if (!currentBody.includes('@github-copilot')) {
              const newBody = copilotInstructions + currentBody;
              
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: pullNumber,
                body: newBody
              });
              
              console.log('GitHub Copilot instructions added to PR description');
            }
            
            // è¿½åŠ ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚ˆã‚Šè©³ç´°ãªæŒ‡ç¤ºã‚’æŠ•ç¨¿
            const detailedInstructions = `ğŸ¤– **GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šå®Œäº†**

ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¾ã™ï¼š

**è¨€èª**: æ—¥æœ¬èª
**ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ«ãƒ¼ãƒ«**:
- \`[must]\` â†’ å¿…ãšå¤‰æ›´ã—ã¦ã»ã—ã„é‡è¦ãªæŒ‡æ‘˜
- \`[imo]\` â†’ å€‹äººçš„ãªæ„è¦‹ï¼ˆä¿®æ­£å¿…é ˆã§ã¯ãªã„ï¼‰  
- \`[nits]\` â†’ äº›ç´°ãªæŒ‡æ‘˜ï¼ˆnitpickï¼‰
- \`[ask]\` â†’ è³ªå•ãƒ»ç¢ºèªäº‹é …
- \`[fyi]\` â†’ å‚è€ƒæƒ…å ±ãƒ»è±†çŸ¥è­˜

@github-copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pullNumber,
              body: detailedInstructions
            });
            
            console.log('Detailed GitHub Copilot review instructions posted');

  trigger-copilot-review:
    runs-on: ubuntu-latest
    needs: setup-copilot-review
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Trigger GitHub Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pullNumber = context.payload.pull_request.number;
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰Copilotã«å†åº¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pullNumber,
              body: '@github-copilot review'
            });
            
            console.log('GitHub Copilot review triggered');
